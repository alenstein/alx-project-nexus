name: üöÄ CD - Deploy to Production

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  # --- Job 1: Prepare the Server ---
  prepare-server:
    name: ‚öôÔ∏è Prepare EC2 Server
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: üìù Create Config Files on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "--- Navigating to project directory ---"
            PROJECT_DIR="/home/ubuntu/ecommerce-backend"
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR

            echo "--- Creating docker-compose.yml ---"
            cat << EOF > docker-compose.yml
            version: '3.8'
            services:
              db:
                image: postgres:14-alpine
                volumes:
                  - postgres_data:/var/lib/postgresql/data/
                environment:
                  POSTGRES_USER: ${{ secrets.DB_USER }}
                  POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  POSTGRES_DB: ${{ secrets.DB_NAME }}
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }}"]
                  interval: 5s
                  timeout: 5s
                  retries: 5
                restart: unless-stopped
              redis:
                image: redis:7-alpine
                restart: unless-stopped
              web:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/ecommerce-backend:latest
                working_dir: /app/eCommerce
                command: >
                  sh -c "
                    python manage.py migrate &&
                    python manage.py create_superuser &&
                    python manage.py seed_db &&
                    /usr/local/bin/gunicorn eCommerce.wsgi:application --bind 0.0.0.0:8000
                  "
                volumes:
                  - ./staticfiles:/app/eCommerce/staticfiles
                env_file: .env
                depends_on:
                  db:
                    condition: service_healthy
                  redis:
                    condition: service_started
                restart: unless-stopped
              celery-worker:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/ecommerce-backend:latest
                working_dir: /app/eCommerce
                command: /usr/local/bin/celery -A eCommerce.celery worker --loglevel=info
                env_file: .env
                depends_on:
                  web:
                    condition: service_started
                  redis:
                    condition: service_started
                restart: unless-stopped
            volumes:
              postgres_data:
            EOF

            echo "--- Creating .env file from secrets ---"
            cat << EOF > .env
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            DEBUG=False
            ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=db
            DB_PORT=5432
            CELERY_BROKER_URL=redis://redis:6379/0
            CELERY_RESULT_BACKEND=redis://redis:6379/0
            EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
            EMAIL_HOST=${{ secrets.EMAIL_HOST }}
            EMAIL_PORT=${{ secrets.EMAIL_PORT }}
            EMAIL_USE_TLS=True
            EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
            EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
            DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }}
            SUPERUSER_EMAIL=${{ secrets.SUPERUSER_EMAIL }}
            SUPERUSER_USERNAME=${{ secrets.SUPERUSER_USERNAME }}
            SUPERUSER_PASSWORD=${{ secrets.SUPERUSER_PASSWORD }}
            EOF

            echo "--- Server preparation complete ---"

  # --- Job 2: Deploy the Services ---
  deploy-services:
    name: üöÄ Deploy and Verify Services
    needs: prepare-server
    runs-on: ubuntu-latest
    steps:
      - name: üöö Deploy, Monitor, and Verify
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            # Exit immediately if any command fails
            set -e

            echo "--- Navigating to project directory ---"
            PROJECT_DIR="/home/ubuntu/ecommerce-backend"
            cd $PROJECT_DIR

            echo "--- Shutting down and removing all existing Docker containers ---"
            # Stop all running containers. `|| true` prevents errors if no containers are running.
            docker stop $(docker ps -q) || true
            # Remove all containers. `|| true` prevents errors if no containers exist.
            docker rm $(docker ps -a -q) || true

            echo "--- Pruning Docker system to remove unused data ---"
            # Prune the system to remove all unused Docker data (images, networks, volumes).
            docker system prune -af --volumes

            echo "--- Pulling latest Docker image from Docker Hub ---"
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/ecommerce-backend:latest

            echo "--- Starting all services with Docker Compose ---"
            docker-compose --env-file .env up -d

            echo "--- Pausing for 15 seconds to allow services to stabilize ---"
            sleep 15

            echo "--- Verifying running services ---"
            # We expect 4 services to be running: db, redis, web, celery-worker
            EXPECTED_SERVICES=4
            RUNNING_SERVICES=$(docker-compose ps -q | wc -l)

            if [ "$RUNNING_SERVICES" -ne "$EXPECTED_SERVICES" ]; then
              echo "üî¥ Error: Expected $EXPECTED_SERVICES services, but only $RUNNING_SERVICES are running."
              docker-compose ps # Print the status for debugging
              exit 1 # Explicitly fail the script
            else
              echo "‚úÖ Success: All $RUNNING_SERVICES services are up and running."
              docker-compose ps
            fi

            echo "--- Deployment complete! ---"
