# This file defines the services and environment for deployment on Render.com
# It uses an Environment Group to securely manage and share variables.

envVarGroups:
  - name: ecommerce-env
    envVars:
      # --- Secrets (set values in Render UI) ---
      - key: SECRET_KEY
      - key: DEBUG
      - key: ALLOWED_HOSTS
      - key: DB_URL # Use the Internal Connection String from your Render DB
      - key: CELERY_BROKER_URL # Use the Internal URL from your Render Redis instance
      - key: EMAIL_HOST_PASSWORD
      - key: SUPERUSER_EMAIL
      - key: SUPERUSER_USERNAME
      - key: SUPERUSER_PASSWORD

      # --- Configurations (set values in Render UI) ---
      - key: PYTHON_VERSION
      - key: WEB_CONCURRENCY
      - key: EMAIL_BACKEND
      - key: EMAIL_HOST
      - key: EMAIL_PORT
      - key: EMAIL_USE_TLS
      - key: EMAIL_HOST_USER
      - key: DEFAULT_FROM_EMAIL

services:
  # --- Redis Instance ---
  - type: redis
    name: ecommerce-redis
    region: oregon
    plan: free # Or a paid plan for production
    ipAllowList: [] # Allow all, or restrict to your service IPs

  # --- Django Web Service ---
  - type: web
    name: ecommerce-backend
    env: python
    region: oregon
    plan: starter # Use 'free' for the free tier
    buildCommand: >-
      pip install -r requirements.txt &&
      python manage.py collectstatic --noinput &&
      python manage.py migrate &&
      python manage.py create_superuser
    startCommand: "gunicorn --bind 0.0.0.0:$PORT eCommerce.wsgi:application"
    healthCheckPath: "/healthz"
    envVarGroup: ecommerce-env
    python:
      version: "3.13.0"

  # --- Celery Worker ---
  - type: worker
    name: ecommerce-celery-worker
    env: python
    region: oregon
    plan: starter # Or 'free'
    buildCommand: "pip install -r requirements.txt"
    startCommand: "celery -A eCommerce worker --loglevel=info"
    envVarGroup: ecommerce-env
    python:
      version: "3.13.0"

  # --- Cron Job for Application Logic (e.g., Stock Checking) ---
  - type: cron
    name: stock-checker-cron
    env: python
    region: oregon
    plan: starter # Or 'free'
    schedule: "0 0 * * *" # Runs daily at midnight UTC
    startCommand: "python manage.py check_stock"
    envVarGroup: ecommerce-env
    python:
      version: "3.13.0"

  # --- Cron Job to Keep the Service Awake (Health Pinger) ---
  - type: cron
    name: health-pinger
    env: shell # Use a lightweight shell environment
    region: oregon
    plan: free # This can run on the free tier
    schedule: "*/8 * * * *"
    startCommand: "curl -sS https://ecommerce-backend-v2-dz2z.onrender.com/healthz"
